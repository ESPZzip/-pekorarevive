<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Foro Pekora</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white min-h-screen flex items-center justify-center">
  <div class="w-full max-w-2xl p-6">
    <h1 class="text-3xl font-bold text-center mb-6">Foro Pekora üêá</h1>

    <!-- Registro -->
    <div id="registerSection" class="space-y-3">
      <h2 class="text-xl font-bold">Crear cuenta</h2>
      <input id="regName" placeholder="Nombre de usuario" class="w-full p-2 rounded text-black">
      <input id="regPass" type="password" placeholder="Contrase√±a" class="w-full p-2 rounded text-black">
      <input id="regPhoto" type="file" accept="image/*" class="w-full p-2 bg-gray-800">
      <button onclick="register()" class="w-full bg-blue-600 p-2 rounded">Registrar</button>
      <p>¬øYa tienes cuenta? <button onclick="showLogin()" class="text-blue-400">Inicia sesi√≥n</button></p>
    </div>

    <!-- Login -->
    <div id="loginSection" class="space-y-3 hidden">
      <h2 class="text-xl font-bold">Iniciar sesi√≥n</h2>
      <input id="logName" placeholder="Nombre de usuario" class="w-full p-2 rounded text-black">
      <input id="logPass" type="password" placeholder="Contrase√±a" class="w-full p-2 rounded text-black">
      <button onclick="login()" class="w-full bg-green-600 p-2 rounded">Entrar</button>
      <p>¬øNo tienes cuenta? <button onclick="showRegister()" class="text-blue-400">Reg√≠strate</button></p>
    </div>

    <!-- Men√∫ principal -->
    <div id="menu" class="hidden space-y-4">
      <div class="flex justify-between items-center">
        <h2 class="text-xl font-bold">Bienvenido, <span id="username"></span></h2>
        <button onclick="logout()" class="bg-red-600 p-2 rounded">Cerrar sesi√≥n</button>
      </div>

      <!-- √Årea de comentarios -->
      <div id="commentsSection" class="space-y-3">
        <textarea id="commentInput" placeholder="Escribe un comentario..." class="w-full p-2 rounded text-black"></textarea>
        <button onclick="postComment()" class="w-full bg-blue-600 p-2 rounded">Publicar</button>
        <div id="commentsList" class="mt-4 space-y-2"></div>
      </div>
    </div>
  </div>

  <script>
    // Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
      authDomain: "pekora-forum.firebaseapp.com",
      projectId: "pekora-forum",
      storageBucket: "pekora-forum.appspot.com",
      messagingSenderId: "161910967859",
      appId: "1:161910967859:web:d91e68d48a6be3b1e9dd46"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentUser = null;

    // Cambiar vistas
    function showRegister() {
      document.getElementById("registerSection").classList.remove("hidden");
      document.getElementById("loginSection").classList.add("hidden");
    }
    function showLogin() {
      document.getElementById("loginSection").classList.remove("hidden");
      document.getElementById("registerSection").classList.add("hidden");
    }
    function showMenu() {
      document.getElementById("registerSection").classList.add("hidden");
      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("menu").classList.remove("hidden");
      document.getElementById("username").innerText = currentUser.name;
    }

    // Guardar sesi√≥n
    window.onload = async function() {
      const savedUser = localStorage.getItem("user");
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        const doc = await db.collection("users").doc(currentUser.name).get();
        if (doc.exists) {
          currentUser = { name: currentUser.name, ...doc.data() };
          localStorage.setItem("user", JSON.stringify(currentUser));
        }
        showMenu();
        loadComments();
      }
    };

    // Registro
    async function register() {
      const name = document.getElementById("regName").value.trim();
      const pass = document.getElementById("regPass").value.trim();
      const file = document.getElementById("regPhoto").files[0];
      if (!name || !pass) return alert("Completa todos los campos");

      const userRef = db.collection("users").doc(name);
      const docUser = await userRef.get();
      if (docUser.exists) return alert("Ese usuario ya existe");

      let photoURL = "";
      if (file) {
        const storageRef = storage.ref("profiles/" + name);
        await storageRef.put(file);
        photoURL = await storageRef.getDownloadURL();
      }

      await userRef.set({
        password: pass,
        rank: name === "Cracky" ? "Admin" : "Usuario",
        rankColor: name === "Cracky" ? "red" : "white",
        photo: photoURL
      });

      currentUser = { name, password: pass, rank: name === "Cracky" ? "Admin" : "Usuario", rankColor: name === "Cracky" ? "red" : "white", photo: photoURL };
      localStorage.setItem("user", JSON.stringify(currentUser));
      showMenu();
      loadComments();
    }

    // Login
    async function login() {
      const name = document.getElementById("logName").value.trim();
      const pass = document.getElementById("logPass").value.trim();
      if (!name || !pass) return alert("Completa todos los campos");

      const userRef = db.collection("users").doc(name);
      const docUser = await userRef.get();
      if (!docUser.exists) return alert("Usuario no encontrado");

      const data = docUser.data();
      if (data.password !== pass) return alert("Contrase√±a incorrecta");

      currentUser = { name, ...data };
      localStorage.setItem("user", JSON.stringify(currentUser));
      showMenu();
      loadComments();
    }

    // Cerrar sesi√≥n
    function logout() {
      currentUser = null;
      localStorage.removeItem("user");
      document.getElementById("menu").classList.add("hidden");
      showLogin();
    }

    // Publicar comentario
    async function postComment() {
      if (!currentUser) return alert("Debes iniciar sesi√≥n");
      const text = document.getElementById("commentInput").value.trim();
      if (!text) return;

      const userDoc = await db.collection("users").doc(currentUser.name).get();
      const photo = userDoc.exists ? userDoc.data().photo || "" : "";

      await db.collection("comments").add({
        author: currentUser.name,
        rank: currentUser.rank,
        rankColor: currentUser.rankColor,
        text,
        photo,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      document.getElementById("commentInput").value = "";
    }

    // Cargar comentarios con bot√≥n borrar
    function loadComments() {
      db.collection("comments").orderBy("timestamp", "desc").onSnapshot(snapshot => {
        const list = document.getElementById("commentsList");
        list.innerHTML = "";
        snapshot.forEach(doc => {
          const c = doc.data();

          const div = document.createElement("div");
          div.className = "bg-gray-800 p-3 rounded flex items-start justify-between";

          div.innerHTML = `
            <div class="flex items-start">
              <img src="${c.photo || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full mr-3">
              <div>
                <p class="font-bold"><span style="color:${c.rankColor || 'white'}">${c.rank} ${c.author}</span></p>
                <p>${c.text}</p>
              </div>
            </div>
          `;

          // Bot√≥n borrar
          if (currentUser && (currentUser.name === c.author || currentUser.name === "Cracky")) {
            const delBtn = document.createElement("button");
            delBtn.innerText = "üóëÔ∏è";
            delBtn.className = "ml-3 text-red-400 hover:text-red-200";
            delBtn.onclick = () => deleteComment(doc.id);
            div.appendChild(delBtn);
          }

          list.appendChild(div);
        });
      });
    }

    // Borrar comentario
    async function deleteComment(id) {
      if (!currentUser) return alert("Debes iniciar sesi√≥n");
      try {
        await db.collection("comments").doc(id).delete();
      } catch (e) {
        console.error(e);
        alert("Error al borrar el comentario");
      }
    }
  </script>
</body>
</html>
