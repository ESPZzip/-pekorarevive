<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Pekora Forum</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #f1f1f1;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      background: #1f1f1f;
      padding: 15px;
      width: 100%;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      color: #00bcd4;
      box-shadow: 0px 2px 6px rgba(0,0,0,0.6);
    }
    .container {
      margin-top: 20px;
      background: #1e1e1e;
      padding: 20px;
      border-radius: 10px;
      width: 400px;
      box-shadow: 0px 2px 10px rgba(0,0,0,0.5);
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: none;
      border-radius: 5px;
    }
    input {
      background: #2c2c2c;
      color: #fff;
    }
    button {
      background: #00bcd4;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #0097a7;
    }
    #comments { margin-top: 20px; }
    .comment {
      background: #2c2c2c;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 8px;
    }
    .author { font-weight: bold; }
    .rank {
      font-weight: bold;
      margin-left: 6px;
    }
    .rank.Admin { color: red; }
    .rank.Moderador { color: orange; }
  </style>
</head>
<body>
  <header>🔥 Pekora Forum</header>

  <div class="container" id="authContainer">
    <h2>Iniciar Sesión</h2>
    <input type="text" id="loginName" placeholder="Nombre de usuario">
    <input type="password" id="loginPass" placeholder="Contraseña">
    <button onclick="login()">Entrar</button>

    <h2>Registrarse</h2>
    <input type="text" id="regName" placeholder="Elige un nombre de usuario">
    <input type="password" id="regPass" placeholder="Elige una contraseña">
    <button onclick="register()">Registrar</button>
  </div>

  <div class="container" id="forumContainer" style="display:none;">
    <h2>Bienvenido <span id="currentUser"></span></h2>
    <div id="adminPanel" style="display:none;">
      <h3>👑 Panel de Admin</h3>
      <input type="text" id="rankUser" placeholder="Nombre del usuario">
      <select id="rankSelect">
        <option value="Admin">Admin</option>
        <option value="Moderador">Moderador</option>
      </select>
      <button onclick="setRank()">Asignar Rango</button>
    </div>

    <textarea id="commentInput" placeholder="Escribe un comentario..." rows="3" style="width:100%;"></textarea>
    <button onclick="postComment()">Comentar</button>

    <div id="comments"></div>
    <button onclick="logout()">Cerrar Sesión</button>
  </div>

  <script>
    // 🔥 Configuración de Firebase
    const firebaseConfig = { 
      apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
      authDomain: "pekora-forum.firebaseapp.com",
      projectId: "pekora-forum",
      storageBucket: "pekora-forum.firebasestorage.app",
      messagingSenderId: "161910967859",
      appId: "1:161910967859:web:d91e68d48a6be3b1e9dd46"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUser = null;

    async function register() {
      const name = document.getElementById("regName").value.trim();
      const pass = document.getElementById("regPass").value.trim();
      if (!name || !pass) return alert("Completa todos los campos");

      const userRef = db.collection("users").doc(name);
      const doc = await userRef.get();
      if (doc.exists) {
        alert("Ese nombre ya está en uso");
      } else {
        await userRef.set({ password: pass, rank: "Usuario" });
        alert("Registrado con éxito, ahora inicia sesión");
      }
    }

    async function login() {
      const name = document.getElementById("loginName").value.trim();
      const pass = document.getElementById("loginPass").value.trim();
      if (!name || !pass) return alert("Completa todos los campos");

      const userRef = db.collection("users").doc(name);
      const doc = await userRef.get();
      if (!doc.exists) return alert("Usuario no encontrado");

      const data = doc.data();
      if (data.password === pass) {
        currentUser = { name, rank: data.rank };
        localStorage.setItem("sessionUser", JSON.stringify(currentUser));
        showForum();
      } else {
        alert("Contraseña incorrecta");
      }
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem("sessionUser");
      document.getElementById("forumContainer").style.display = "none";
      document.getElementById("authContainer").style.display = "block";
    }

    async function postComment() {
      const text = document.getElementById("commentInput").value.trim();
      if (!text) return;
      await db.collection("comments").add({
        author: currentUser.name,
        rank: currentUser.rank,
        text,
        ts: new Date()
      });
      document.getElementById("commentInput").value = "";
    }

    function loadComments() {
      db.collection("comments").orderBy("ts").onSnapshot(snapshot => {
        const commentsDiv = document.getElementById("comments");
        commentsDiv.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement("div");
          div.className = "comment";
          div.innerHTML = `<span class="author">${data.author}</span>
                           <span class="rank ${data.rank}">${data.rank}</span>: ${data.text}`;
          commentsDiv.appendChild(div);
        });
      });
    }

    async function setRank() {
      const user = document.getElementById("rankUser").value.trim();
      const rank = document.getElementById("rankSelect").value;
      if (!user) return alert("Escribe un nombre de usuario");

      await db.collection("users").doc(user).update({ rank });
      alert("Rango asignado con éxito");
    }

    function showForum() {
      document.getElementById("authContainer").style.display = "none";
      document.getElementById("forumContainer").style.display = "block";
      document.getElementById("currentUser").innerText = currentUser.name;

      if (currentUser.name === "Cracky") {
        document.getElementById("adminPanel").style.display = "block";
      } else {
        document.getElementById("adminPanel").style.display = "none";
      }

      loadComments();
    }

    // 🔄 Mantener sesión al recargar
    window.onload = () => {
      const saved = localStorage.getItem("sessionUser");
      if (saved) {
        currentUser = JSON.parse(saved);
        showForum();
      }
    };
  </script>
</body>
</html>
