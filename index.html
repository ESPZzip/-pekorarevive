<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Foro Pekora</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">
  <!-- Barra superior -->
  <header class="bg-gray-800 shadow-md p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-purple-400">✨ Foro Pekora</h1>
    <nav>
      <button onclick="showSection('loginSection')" class="mx-2 px-4 py-2 rounded bg-purple-600 hover:bg-purple-500">Login</button>
      <button onclick="showSection('registerSection')" class="mx-2 px-4 py-2 rounded bg-green-600 hover:bg-green-500">Registro</button>
      <button onclick="logout()" class="mx-2 px-4 py-2 rounded bg-red-600 hover:bg-red-500">Salir</button>
    </nav>
  </header>

  <!-- Login -->
  <section id="loginSection" class="p-6 max-w-md mx-auto mt-8 bg-gray-800 rounded-2xl shadow-lg">
    <h2 class="text-xl font-semibold text-purple-300 mb-4">Iniciar Sesión</h2>
    <input id="loginName" type="text" placeholder="Usuario" class="w-full mb-3 p-2 rounded bg-gray-700 border border-gray-600">
    <input id="loginPass" type="password" placeholder="Contraseña" class="w-full mb-3 p-2 rounded bg-gray-700 border border-gray-600">
    <button onclick="login()" class="w-full px-4 py-2 bg-purple-600 rounded hover:bg-purple-500">Entrar</button>
  </section>

  <!-- Registro -->
  <section id="registerSection" class="p-6 max-w-md mx-auto mt-8 bg-gray-800 rounded-2xl shadow-lg hidden">
    <h2 class="text-xl font-semibold text-green-300 mb-4">Crear Cuenta</h2>
    <input id="regName" type="text" placeholder="Usuario" class="w-full mb-3 p-2 rounded bg-gray-700 border border-gray-600">
    <input id="regPass" type="password" placeholder="Contraseña" class="w-full mb-3 p-2 rounded bg-gray-700 border border-gray-600">
    <button onclick="register()" class="w-full px-4 py-2 bg-green-600 rounded hover:bg-green-500">Registrar</button>
  </section>

  <!-- Panel principal -->
  <section id="mainSection" class="p-6 max-w-2xl mx-auto mt-8 bg-gray-800 rounded-2xl shadow-lg hidden">
    <h2 class="text-xl font-semibold text-blue-300 mb-4">Comentarios</h2>
    <div class="flex mb-4">
      <input id="commentInput" type="text" placeholder="Escribe tu comentario..." class="flex-1 p-2 rounded-l bg-gray-700 border border-gray-600">
      <button onclick="postComment()" class="px-4 py-2 bg-blue-600 rounded-r hover:bg-blue-500">Enviar</button>
    </div>
    <div id="comments" class="space-y-4"></div>
  </section>

  <script>
    // Config Firebase
    const firebaseConfig = { 
      apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
      authDomain: "pekora-forum.firebaseapp.com",
      projectId: "pekora-forum",
      storageBucket: "pekora-forum.firebasestorage.app",
      messagingSenderId: "161910967859",
      appId: "1:161910967859:web:d91e68d48a6be3b1e9dd46"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUser = null;

    function showSection(id) {
      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("registerSection").classList.add("hidden");
      document.getElementById("mainSection").classList.add("hidden");
      document.getElementById(id).classList.remove("hidden");
    }

    async function register() {
      const name = document.getElementById("regName").value.trim();
      const pass = document.getElementById("regPass").value.trim();
      if (!name || !pass) return alert("Completa todos los campos");

      try {
        const userRef = db.collection("users").doc(name);
        const doc = await userRef.get();
        if (doc.exists) {
          alert("Ese nombre ya está en uso");
        } else {
          await userRef.set({ password: pass, rank: "Usuario" });
          alert("Registrado con éxito, ahora inicia sesión");
          showSection("loginSection");
        }
      } catch (e) {
        console.error(e);
        alert("Error al registrar");
      }
    }

    async function login() {
      const name = document.getElementById("loginName").value.trim();
      const pass = document.getElementById("loginPass").value.trim();
      if (!name || !pass) return alert("Completa todos los campos");

      try {
        const userRef = db.collection("users").doc(name);
        const doc = await userRef.get();
        if (!doc.exists || doc.data().password !== pass) {
          alert("Usuario o contraseña incorrectos");
          return;
        }
        currentUser = { name, rank: doc.data().rank || "Usuario" };
        localStorage.setItem("user", JSON.stringify(currentUser));
        showSection("mainSection");
        loadComments();
      } catch (e) {
        console.error(e);
        alert("Error al iniciar sesión");
      }
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem("user");
      showSection("loginSection");
    }

    async function postComment() {
      if (!currentUser) return alert("Debes iniciar sesión");
      const text = document.getElementById("commentInput").value.trim();
      if (!text) return;
      await db.collection("comments").add({
        author: currentUser.name,
        rank: currentUser.rank,
        text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById("commentInput").value = "";
    }

    function loadComments() {
      db.collection("comments").orderBy("timestamp", "desc").onSnapshot(snapshot => {
        const commentsDiv = document.getElementById("comments");
        commentsDiv.innerHTML = "";
        snapshot.forEach(doc => {
          const c = doc.data();
          const rankColor = c.rank === "Admin" ? "text-red-400" : "text-gray-400";
          commentsDiv.innerHTML += `
            <div class="p-4 bg-gray-700 rounded-lg shadow">
              <p><span class="font-bold text-purple-300">${c.author}</span> 
                 <span class="${rankColor}">(${c.rank})</span></p>
              <p class="mt-1">${c.text}</p>
            </div>`;
        });
      });
    }

    // Restaurar sesión
    window.onload = () => {
      const saved = localStorage.getItem("user");
      if (saved) {
        currentUser = JSON.parse(saved);
        showSection("mainSection");
        loadComments();
      } else {
        showSection("loginSection");
      }
    };
  </script>
</body>
</html>
